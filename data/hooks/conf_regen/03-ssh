#!/bin/bash

set -e

. /usr/share/yunohost/helpers.d/utils

do_pre_regen() {
  pending_dir=$1

  cd /usr/share/yunohost/templates/ssh

  # Don't overwrite configuration if from_script
  if [[ ! -f /etc/yunohost/from_script ]]; then

      # do not listen to IPv6 if unavailable
      [[ -f /proc/net/if_inet6 ]] && ipv6_enabled=true || ipv6_enabled=false

      ssh_keys=$(ls /etc/ssh/ssh_host_{ed25519,rsa,ecdsa}_key 2>/dev/null)

      # Support legacy setting (this setting might be disabled by a user during a migration)
      if [[ "$(yunohost settings get 'service.ssh.allow_deprecated_dsa_hostkey')" == "True" ]]; then
          ssh_keys="$ssh_keys $(ls /etc/ssh/ssh_host_dsa_key 2>/dev/null)"
      fi

      export ssh_keys
      export ipv6_enabled
      ynh_render_template "sshd_config" "${pending_dir}/etc/ssh/sshd_config"
  fi
}

do_post_regen() {
	regen_conf_files=$1
	if [[ ! -f /etc/yunohost/from_script ]]; then
		if [[ -n "$regen_conf_files" ]];
		then
			sudo service ssh restart
			chown root:root "/etc/ssh/sshd_config"
			chmod 644 "/etc/ssh/sshd_config"
		fi
	fi
}

FORCE=${2:-0}
DRY_RUN=${3:-0}

case "$1" in
  pre)
    do_pre_regen $4
    ;;
  post)
    do_post_regen $4
    ;;
  *)
    echo "hook called with unknown argument \`$1'" >&2
    exit 1
    ;;
esac

exit 0
