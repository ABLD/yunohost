#!/bin/bash
set -e 

force=$1

function safe_copy () {
    if [[ "$force" == "True" ]]; then
        sudo yunohost service safecopy \
          -s metronome \
          $1 $2 \
          --force
    else
        sudo yunohost service safecopy \
          -s metronome \
          $1 $2
    fi
}

cd /usr/share/yunohost/templates/metronome

# Copy additional modules
files="ldap.lib.lua
mod_auth_ldap2.lua
mod_legacyauth.lua
mod_storage_ldap.lua
vcard.lib.lua"

for file in $files; do
    safe_copy modules/$file /usr/lib/metronome/modules/$file
done

# Copy configuration files
main_domain=$(cat /etc/yunohost/current_host)
cat metronome.cfg.lua.sed \
  | sed "s/{{ main_domain }}/$main_domain/g" \
  | sudo tee metronome.cfg.lua
safe_copy metronome.cfg.lua /etc/metronome/metronome.cfg.lua
safe_copy metronome.init /etc/init.d/metronome
safe_copy metronome.logrotate /etc/logrotate.d/metronome

need_restart=False
sudo mkdir -p /etc/metronome/conf.d

# Copy a configuration file for each YunoHost domain 
for domain in $(sudo yunohost domain list --raw); do
    cat domain.cfg.lua.sed \
      | sed "s/{{ domain }}/$domain/g" \
      | sudo tee $domain.cfg.lua
    if [[ $(safe_copy $domain.cfg.lua /etc/metronome/conf.d/$domain.cfg.lua) == "True" ]]; then
        need_restart=True
    fi
done

# Restart if need be
if [[ "$need_restart" == "True" ]]; then
    sudo service metronome restart
else
    sudo service metronome reload
fi
